---
title: "Nguyen Instrument - 11/22/2025"
format:
  html:
    page-layout: full
    # optional: keep text from getting too wide
    # css: styles.css
    code-overflow: scroll
    code-fold: true
    number-sections: true
    self-contained: true
editor: source
execute: 
  warning: false
  echo: true
---


```{r}
suppressMessages({
  rm(list=ls())
  library(data.table)
  library(fixest)
  library(DescTools)
  library(dplyr)
  library(ggplot2)
  library(gridExtra)
  library(readxl)
  library(stringr)
  library(marginaleffects)
  library(scales)
  library(lubridate)
})
source('https://raw.githubusercontent.com/dratnadiwakara/r-utilities/refs/heads/main/summary_stat_tables.R')
```



# Nguyen 2019 - Figure 2 Replication (branch-year sample)

```{r}
# ---- 1. Load Data ----
# Load your specific files
branch_panel <- readRDS("C:/data/closure_opening_data_simple.rds")
instrument_dt <- readRDS("C:/data/nguyen_instrument_zips.rds")

setDT(branch_panel)
setDT(instrument_dt)

# ---- 2. Data Prep: Define the Event Panel ----

# A. Identify the first "Treatment Year" per Zip
# (If a Zip is treated multiple times, we typically take the first instance)
zip_event_years <- instrument_dt[, .(Event_Year = min(Event_Year)), by = ZIPBR]

# B. Standardize Join Keys
branch_panel[, ZIPBR := sprintf("%05s", as.character(ZIPBR))]
zip_event_years[, ZIPBR := sprintf("%05s", as.character(ZIPBR))]

# C. Merge to create the Analysis Dataset
# 'treated_panel' will contain both Treated branches and Control branches
treated_panel <- merge(branch_panel, zip_event_years, by = "ZIPBR", all.x = TRUE)

# D. Calculate Relative Time
# rel_year = The year relative to the merger approval
treated_panel[, rel_year := YEAR - Event_Year]

# ---- 3. Handling the Control Group (Crucial for fixest) ----
# In fixest, rows with NA in the variable of interest are dropped. 
# To keep Control branches (who have NA rel_year) in the regression 
# (so they contribute to the Year and Zip Fixed Effects), we assign them 
# a "dummy" relative year that is far outside our plotting window.
treated_panel[is.na(rel_year), rel_year := -1000]

# ---- 4. Estimation (Replicating Eq 3) ----
# We use i() to create the event study dummies.
# ref = -1:  Sets t = -1 as the baseline (coefficient = 0).
# keep = -5:8 : Only estimates coefficients for this window (bins others or drops).
# Note: The value -1000 (Controls) is excluded from 'keep', so they serve 
# purely as part of the reference group for the Fixed Effects.

est_event <- feols(closed ~ i(rel_year, ref = -1, keep = -5:5) | 
                     ZIPBR + YEAR,               # Fixed Effects (Tract + Year)
                   cluster = ~STCNTYBR,        # Clustered Errors (County level)
                   data = treated_panel)

# Print results to console to check significance
print(est_event)

# ---- 5. Visualization (Replicating Figure 2) ----
# iplot automatically extracts the coefficients from i() and plots them.

iplot(est_event, 
      # Visual Settings
      main = "Impact of Merger Exposure on Branch Closings",
      xlab = "Years since merger",
      ylab = "Probability of Branch Closing",
      
      # Confidence Intervals
      ci_level = 0.95,       # 95% CI bars
      ci.width = 0,          # Width of the end caps (0 = simple lines)
      pt.join = TRUE,        # Join points with a line (like Figure 2)
      grid = TRUE,           # Add background grid
      
      # Colors (mimicking the blue style)
      col = "navy",
      pt.pch = 20,           # Solid circle points
      pt.cex = 1.5,
      
      xlim = c(-6, 6))          # Point size

# Add the vertical dashed line at t=0 manually if desired
abline(v = 0, col = "gray", lty = 2)
```


```{r}
dt <- readRDS("C:/data/zip_competition_churn_panel_refined_8.rds")

setDT(dt)

zip_county <- fread("C:/data/zip_to_county_mapping.csv")
zip_county[,ZIP:=str_pad(ZIP,5,"left","0")]
zip_cbsa <- fread("C:/data/zip_to_cbsa_mapping.csv")
zip_cbsa[,ZIP:=str_pad(ZIP,5,"left","0")]

dt <- merge(dt,zip_county,by.x="ZIPBR",by.y="ZIP")
dt <- merge(dt,zip_cbsa,by.x="ZIPBR",by.y="ZIP")

dt[,county_yr:=paste(COUNTY,YEAR)]
dt[,cbsa_yr:=paste(CBSA,YEAR)]


dt <- dt[branches_zip_lag1>=2 & n_incumbent_banks>=2]
```


```{r}
dt[,share_deps_closed:=Winsorize(share_deps_closed, val = quantile(share_deps_closed, probs = c(0, 0.99), na.rm = T)),by=YEAR]
dt[,share_closed_small :=Winsorize(share_closed_small , val = quantile(share_closed_small , probs = c(0, 0.99), na.rm = T)),by=YEAR]
dt[,share_closed_large :=Winsorize(share_closed_large , val = quantile(share_closed_large , probs = c(0, 0.99), na.rm = T)),by=YEAR]


dt[,incumbent_growth_share_1yr:=Winsorize(incumbent_growth_share_1yr, val = quantile(incumbent_growth_share_1yr, probs = c(0.01, 0.99), na.rm = T)),by=YEAR]
dt[,incumbent_growth_share_3yr:=Winsorize(incumbent_growth_share_3yr, val = quantile(incumbent_growth_share_3yr, probs = c(0.01, 0.99), na.rm = T)),by=YEAR]

# dt[,incumbent_growth_share_1yr_from_last:=Winsorize(incumbent_growth_share_1yr_from_last, val = quantile(incumbent_growth_share_1yr_from_last, probs = c(0.01, 0.99), na.rm = T)),by=YEAR]
# dt[,incumbent_growth_share_3yr_from_last:=Winsorize(incumbent_growth_share_3yr_from_last, val = quantile(incumbent_growth_share_3yr_from_last, probs = c(0.01, 0.99), na.rm = T)),by=YEAR]

dt[,incumbent_growth_share_3yr_own_deposits:=Winsorize(incumbent_growth_share_3yr_own_deposits, val = quantile(incumbent_growth_share_3yr_own_deposits, probs = c(0.01, 0.99), na.rm = T)),by=YEAR]
dt[,incumbent_growth_share_1yr_own_deposits:=Winsorize(incumbent_growth_share_1yr_own_deposits, val = quantile(incumbent_growth_share_1yr_own_deposits, probs = c(0.01, 0.99), na.rm = T)),by=YEAR]

dt[,gr_3yr:=incumbent_growth_share_3yr]
dt[,gr_3yr_own:=incumbent_growth_share_3yr_own_deposits]
```


```{r}
instrument_dt <- readRDS("C:/data/nguyen_instrument_zips.rds")
setDT(instrument_dt)
instrument_dt <- unique(instrument_dt,by = c("ZIPBR","Event_Year"))


dt <- merge(dt, 
           instrument_dt[, .(ZIPBR, YEAR = Event_Year, Expose_Event = 1)],
           by = c("ZIPBR", "YEAR"),
           all.x = TRUE)

dt[is.na(Expose_Event), Expose_Event := 0]

dt[,deps_openings_by_closers_share:=deps_openings_by_closers_curr/total_deps_zip_lag1]

dt[,closed:=ifelse(share_deps_closed>0,1,0)]
```


```{r}
# 8. Zip code level characteristics -----------------------

# library(readxl)
# library(stringr)
# 
# acs_data <- readRDS("C:/data/acs_data_2010_2022_tract.rds")
# 
# tract_zip_crosswalk <- read_excel('C:/data/ZIP_TRACT_122019.xlsx')
# tract_zip_crosswalk <- data.table(tract_zip_crosswalk)
# tract_zip_crosswalk[,zip:=str_pad(ZIP,5,"left","0")]
# tract_zip_crosswalk[,tract:=as.character(TRACT)]
# tract_zip_crosswalk[,tract:=str_pad(tract,11,"left","0")]
# tract_zip_crosswalk[,tot_ratio:=TOT_RATIO]
# 
# 
# acs_with_zip <- acs_data %>%
#   left_join(tract_zip_crosswalk[,c("zip","tract","tot_ratio")], by = c("tract" = "tract"))
# 
# 
# 
# zip_aggregated_data <- acs_with_zip %>%
#   group_by(zip,yr) %>%
#   summarize(
#     # Weighted average of median income
#     median_income = sum(median_income * tot_ratio, na.rm = T) ,
#     
#     # Weighted average of percentage of population with a bachelor's degree
#     pct_college_educated = sum(pct_college_educated * tot_ratio, na.rm=T),
#     
#     # Weighted average of white population percentage
#     # white_population_pct = sum(white_populationE * RES_RATIO,na.rm=T),
#     
#     # Weighted average of median age
#     median_age = sum(median_age * tot_ratio,na.rm = T)
#     
#     # Total population is weighted by RES_RATIO
#     # total_population = sum(total_populationE * RES_RATIO)
#   )
# 
# zip_aggregated_data <- data.table(zip_aggregated_data)
# 
# irs_data <- readRDS("C:/data/irs_data_2010_2022_zip.rds")
# 
# 
# irs_data <- irs_data[,c("zipcode","yr","dividend_frac","capital_gain_frac")]
# irs_data[,zipcode:=str_pad(zipcode,5,"left","0")]
# # 
# zip_demo_data <- merge(zip_aggregated_data,irs_data,by.x=c("zip","yr"),by.y=c("zipcode","yr"),all.x=T)
# 
# 
# key_chars <- c("median_income","median_age","pct_college_educated","capital_gain_frac","dividend_frac")
# 
# zip_demo_data <- data.table(zip_demo_data)
# zip_demo_data[,paste0(key_chars,"_q"):=lapply(.SD, function(x) ntile(x,3)),by=yr,.SDcols = key_chars]
# 
# zip_demo_data[,sophisticated_ed_sm:=ifelse(!is.na(dividend_frac)  & pct_college_educated_q==3 & (dividend_frac_q==3 | capital_gain_frac_q==3),1,
#                                            ifelse(!is.na(dividend_frac),0,NA))]
# 
# 
# zip_demo_data <- zip_demo_data[,c("zip","yr","median_income","median_age","pct_college_educated","capital_gain_frac","dividend_frac","sophisticated_ed_sm")]
# 
# zip_demo_data[,age_bin:=ntile(median_age,2),by=yr]
# zip_demo_data[,above_median_age:=ifelse(age_bin==2,1,0)]
# zip_demo_data[,income_bin:=ntile(median_income,2),by=yr]
# zip_demo_data[,above_median_income:=ifelse(income_bin==2,1,0)]
# 
# temp1 <- zip_demo_data[yr==2010]
# for(y in c(2000:2009,2011:2012)) {
#   temp <- copy(temp1)
#   temp[,yr:=y]
#   zip_demo_data <- rbind(zip_demo_data,temp)
# }
# 
# temp1 <- zip_demo_data[yr==2013]
# for(y in 2014:2015) {
#   temp <- copy(temp1)
#   temp[,yr:=y]
#   zip_demo_data <- rbind(zip_demo_data,temp)
# }
# 
# 
# 
# temp1 <- zip_demo_data[yr==2016]
# for(y in 2017:2018) {
#   temp <- copy(temp1)
#   temp[,yr:=y]
#   zip_demo_data <- rbind(zip_demo_data,temp)
# }
# 
# 
# temp1 <- zip_demo_data[yr==2019]
# for(y in 2020:2021) {
#   temp <- copy(temp1)
#   temp[,yr:=y]
#   zip_demo_data <- rbind(zip_demo_data,temp)
# }
# 
# temp1 <- zip_demo_data[yr==2022]
# for(y in 2023:2025) {
#   temp <- copy(temp1)
#   temp[,yr:=y]
#   zip_demo_data <- rbind(zip_demo_data,temp)
# }
# 
# saveRDS(zip_demo_data,"C:/data/zip_demo_data.rds")
zip_demo_data <- readRDS("C:/data/zip_demo_data.rds")

dt <- merge(dt,
            zip_demo_data[!is.na(zip),.(zip,yr,sophisticated_ed_sm,age_bin,median_age,median_income,
                                        pct_college_educated,capital_gain_frac,dividend_frac,above_median_age,
                                        above_median_income)],
            by.x=c("ZIPBR","YEAR"),
            by.y=c("zip","yr"),
            all.x=T)

dt <- dt[!is.na(sophisticated_ed_sm)]
dt[, sophisticated_ed_sm := as.integer(sophisticated_ed_sm == 1L)]
dt[, factor_age_bin := factor(age_bin)]
dt[, log_income := log1p(median_income)]

dt[, small_shock := total_closed_vol_zip_lag1 < 100000]

```



# First Stage

```{r}

fs <- list()
fs[[1]] <- feols(share_deps_closed ~ Expose_Event + log1p(branches_zip_lag1) | 
                     ZIPBR+YEAR , 
                     cluster = ~ZIPBR,
                     data = dt)

fs[[2]] <- feols(share_deps_closed ~ Expose_Event + log1p(branches_zip_lag1) | 
                     ZIPBR+YEAR , 
                     cluster = ~ZIPBR,
                     data = dt[share_deps_closed>0])

md_table(etable(fs, fitstat = c("n", "r2", "f", "ivf"),headers = c("Full Sample","Only share>0")) )
```

# Second Stage

## LHS and RHS same denominator

```{r}
r <- list()

r[["ols_full_sample"]] <- feols(gr_3yr ~ share_deps_closed + log1p(branches_zip_lag1) | 
                   ZIPBR + YEAR, 
                   cluster = ~ZIPBR,
                   data = dt)

r[["ols_share_gt_0"]] <- feols(gr_3yr ~ share_deps_closed + log1p(branches_zip_lag1) | 
                   ZIPBR + YEAR, 
                   cluster = ~ZIPBR,
                   data = dt[share_deps_closed>0])

r[["iv_full_sample"]] <- feols(gr_3yr ~ log1p(branches_zip_lag1) | 
                  ZIPBR + YEAR | 
                  share_deps_closed ~ Expose_Event, 
                  cluster = ~ZIPBR,
                  data = dt)

r[["iv_gt_0"]] <- feols(gr_3yr ~ log1p(branches_zip_lag1) | 
                  ZIPBR + YEAR | 
                  share_deps_closed ~ Expose_Event, 
                  cluster = ~ZIPBR,
                  data = dt[share_deps_closed>0])

r[["iv_interacted"]] <- feols(gr_3yr ~ log1p(branches_zip_lag1) + sophisticated_ed_sm | 
                  ZIPBR + YEAR|
                  # Endogenous vars ~ Instruments
                  share_deps_closed + share_deps_closed:sophisticated_ed_sm ~ Expose_Event + Expose_Event:sophisticated_ed_sm, 
   
                  data = dt[share_deps_closed > 0])

md_table(etable(r, fitstat = c("n", "r2", "f", "ivf"),
                headers=c("OLS - Full Smp","OLS Share >0","IV - Full Smp","IV Share >0", "IV Interac")) )
```

## RHS only incumbent growth

```{r}
r <- list()

r[["ols_full_sample"]] <- feols(gr_3yr_own ~ share_deps_closed + log1p(branches_zip_lag1) | 
                   ZIPBR + YEAR, 
                   cluster = ~ZIPBR,
                   data = dt)

r[["ols_share_gt_0"]] <- feols(gr_3yr_own ~ share_deps_closed + log1p(branches_zip_lag1) | 
                   ZIPBR + YEAR, 
                   cluster = ~ZIPBR,
                   data = dt[share_deps_closed>0])

r[["iv_full_sample"]] <- feols(gr_3yr_own ~ log1p(branches_zip_lag1) | 
                  ZIPBR + YEAR | 
                  share_deps_closed ~ Expose_Event, 
                  cluster = ~ZIPBR,
                  data = dt)

r[["iv_gt_0"]] <- feols(gr_3yr_own ~ log1p(branches_zip_lag1) | 
                  ZIPBR + YEAR | 
                  share_deps_closed ~ Expose_Event, 
                  cluster = ~ZIPBR,
                  data = dt[share_deps_closed>0])

r[["iv_interacted"]] <- feols(gr_3yr_own ~ log1p(branches_zip_lag1) + sophisticated_ed_sm | 
                  ZIPBR + YEAR|
                  # Endogenous vars ~ Instruments
                  share_deps_closed + share_deps_closed:sophisticated_ed_sm ~ Expose_Event + Expose_Event:sophisticated_ed_sm, 
   
                  data = dt[share_deps_closed > 0])

md_table(etable(r, fitstat = c("n", "r2", "f", "ivf"),
                headers=c("OLS - Full Smp","OLS Share >0","IV - Full Smp","IV Share >0", "IV Interac")) )
```
