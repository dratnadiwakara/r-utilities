---
title: "Preliminary Results - 11/15/2025"
format:
  html:
    page-layout: full
    # optional: keep text from getting too wide
    # css: styles.css
    code-overflow: scroll
    number-sections: true
    self-contained: true
editor: source
execute: 
  warning: false
  echo: false
---


```{r}
rm(list=ls())
library(data.table)
library(fixest)
library(DescTools)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(readxl)
library(stringr)

source('https://raw.githubusercontent.com/dratnadiwakara/r-utilities/refs/heads/main/summary_stat_tables.R')
```


```{r}
dt <- readRDS("C:/data/branch_competition_panel.rds")
setDT(dt)

dt <- dt[is.finite(dep_gr)]

# Ensure sophistication is 0/1 (drop NAs or keep with 0/1+NA dummies)
dt <- dt[!is.na(sophisticated_ed_sm)]
dt[, sophisticated_ed_sm := as.integer(sophisticated_ed_sm == 1L)]

setorder(dt,UNINUMBR,YEAR)
dt[, close_flag := own_closures_zip]
dt[, open_flag := own_openings_zip]

# 2) Previous 1–3 and next 1–3 years (by row within bank–ZIP)
dt[, `:=`(
  close_l1 = shift(close_flag, 1, type = "lag"),
  close_l2 = shift(close_flag, 2, type = "lag"),
  close_l3 = shift(close_flag, 3, type = "lag"),
  close_f1 = shift(close_flag, 1, type = "lead"),
  close_f2 = shift(close_flag, 2, type = "lead"),
  close_f3 = shift(close_flag, 3, type = "lead"),
  open_l1 = shift(open_flag, 1, type = "lag"),
  open_l2 = shift(open_flag, 2, type = "lag"),
  open_l3 = shift(open_flag, 3, type = "lag"),
  open_f1 = shift(open_flag, 1, type = "lead"),
  open_f2 = shift(open_flag, 2, type = "lead"),
  open_f3 = shift(open_flag, 3, type = "lead")
), by = .(UNINUMBR)]


dt[,competitor_closures_rate:=Winsorize(competitor_closures_rate, val = quantile(competitor_closures_rate, probs = c(0.01, 0.99), na.rm = T))]
dt[,competitor_close_dep_share_prev:=Winsorize(competitor_close_dep_share_prev, val = quantile(competitor_close_dep_share_prev, probs = c(0.01, 0.99), na.rm = T))]
dt[,competitor_openings_rate:=Winsorize(competitor_openings_rate, val = quantile(competitor_openings_rate, probs = c(0.01, 0.99), na.rm = T))]

dt[,zip_yr:=paste(ZIPBR,YEAR)]

dt[,county:=str_pad(STCNTY,5,"left","0")]
dt[,county_yr:=paste(county,YEAR)]



dt_sub_2 <- dt[own_closures_zip == 0 & close_l1==0 & close_l2==0 & close_l3==0 &close_f1==0 &close_f2==0 &close_f3==0 &
             own_openings_zip == 0 & open_l1==0 & open_l2==0 & open_l3==0 & open_f1==0 & open_f2==0 & open_f3==0 &
               dep_gr < 1]

dt_sub_1 <- dt[own_closures_zip == 0 &
             own_openings_zip == 0 &
               dep_gr < 1]


```


# Descriptive Stats

## Dependent Variable: (Deposits$_{t+3}$ - Deposits$_{t+1}$)/Assets$_t$

```{r}
ggplot(dt_sub_1[YEAR>2001 & YEAR<2022],aes(x=dep_gr))+geom_histogram()+facet_wrap(~YEAR)
```
## Key RHS Variables 

```{r}
g1 <- ggplot(dt_sub_1,aes(x=competitor_closures_rate))+geom_histogram()+ggtitle("competitor_closures_rate")
g2 <- ggplot(dt_sub_1,aes(x=competitor_openings_rate))+geom_histogram()+ggtitle("competitor_openings_rate")
grid.arrange(g1,g2,nrow=1)
```


```{r}
setFixest_fml(
  ..fixef     = ~ UNINUMBR + county_yr,
  ..vcov      = ~ UNINUMBR,
  ..fml_baseline = ~competitor_closures_rate + competitor_openings_rate + log1p(DEPSUMBR) ,
  ..fml_baseline2 = ~competitor_close_dep_share_prev+ + competitor_openings_rate + log1p(DEPSUMBR),
  ..fml_interaction = ~competitor_closures_rate*sophisticated_ed_sm + competitor_openings_rate*sophisticated_ed_sm + log1p(DEPSUMBR),
  ..fml_interaction2 = ~competitor_close_dep_share_prev*sophisticated_ed_sm + competitor_openings_rate*sophisticated_ed_sm + log1p(DEPSUMBR)
)

sub_use <- dt$own_closures_zip == 0 & dt$own_openings_zip == 0 & dt$dep_gr < 1



dict <- c(
  dep_gr                        = "Dep gr(3y fwd)",
  competitor_closures_rate      = "Competitor closure no share (ZIP, rate)",
  competitor_openings_rate      = "Competitor openings no share (ZIP, rate)",
  competitor_close_dep_share_prev = "Competitor closure deposit share (t−1)",
  sophisticated_ed_sm           = "Sophisticated ZIP",
  "log1p(DEPSUMBR)"                = "Log(1 + Deposits)"
)


setFixest_etable(
  dict        = dict,
  se.below    = TRUE
)
```

# Main Result Version 01

Restrict branch-years to branches that had no openings or closures in the current year

```{r}
est1 <- feols(
  dep_gr ~ ..fml_baseline|..fixef,
  data = dt_sub_1

)

est2 <- feols(
  dep_gr ~ ..fml_baseline2|..fixef,
  data = dt_sub_1
)

est3 <- feols(
  dep_gr ~ ..fml_interaction|..fixef,
  data = dt_sub_1
)

est4 <- feols(
  dep_gr ~ ..fml_interaction2|..fixef,
  data = dt_sub_1
)

md_table(etable(est1,est2,est3,est4,signif.code =  c("***"=0.01, "**"=0.05, "*"=0.10)))
```



# Main Result Version 02

Restrict branch-years to branches that had no openings or closures in the current year, <b> next three years, and previous three years</b>

```{r}
est1 <- feols(
  dep_gr ~ ..fml_baseline|..fixef,
  data = dt_sub_2

)

est2 <- feols(
  dep_gr ~ ..fml_baseline2|..fixef,
  data = dt_sub_2
)

est3 <- feols(
  dep_gr ~ ..fml_interaction|..fixef,
  data = dt_sub_2
)

est4 <- feols(
  dep_gr ~ ..fml_interaction2|..fixef,
  data = dt_sub_2
)

md_table(etable(est1,est2,est3,est4,signif.code =  c("***"=0.01, "**"=0.05, "*"=0.10)))
```


# By Time Version 01

Restrict branch-years to branches that had no openings or closures in the current year

```{r}
est1 <- feols(
  dep_gr ~ ..fml_interaction|..fixef,
  data = dt_sub_1[YEAR %in% 2003:2007]
)

est2 <- feols(
  dep_gr ~ ..fml_interaction|..fixef,
  data = dt_sub_1[YEAR %in% 2008:2011]
)

est3 <- feols(
  dep_gr ~ ..fml_interaction|..fixef,
  data = dt_sub_1[YEAR %in% 2012:2019]
)

est4 <- feols(
  dep_gr ~ ..fml_interaction|..fixef,
  data = dt_sub_1[YEAR %in% 2020:2021]
)

md_table(
  etable(est1,est2,est3,est4,
       headers= c("2003:2007","2008:2011","2012:2019","2020:2021"),
      signif.code =  c("***"=0.01, "**"=0.05, "*"=0.10))
)
```



# By Time Version 02

Restrict branch-years to branches that had no openings or closures in the current year, <b> next three years, and previous three years</b>

```{r}
est1 <- feols(
  dep_gr ~ ..fml_interaction|..fixef,
  data = dt_sub_2[YEAR %in% 2003:2007]
)

est2 <- feols(
  dep_gr ~ ..fml_interaction|..fixef,
  data = dt_sub_2[YEAR %in% 2008:2011]
)

est3 <- feols(
  dep_gr ~ ..fml_interaction|..fixef,
  data = dt_sub_2[YEAR %in% 2012:2019]
)

# est4 <- feols(
#   dep_gr ~ ..fml_interaction|..fixef,
#   data = dt_sub_1[YEAR %in% 2020:2021]
# )

md_table(
  etable(est1,est2,est3,
       headers= c("2003:2007","2008:2011","2012:2019"),
      signif.code =  c("***"=0.01, "**"=0.05, "*"=0.10))
)
```
