---
title: "Zip-YEAR - 11/25/2025"
format:
  html:
    page-layout: full
    # optional: keep text from getting too wide
    # css: styles.css
    code-overflow: scroll
    code-fold: true
    number-sections: true
    self-contained: true
editor: source
execute: 
  warning: false
  echo: true
---


```{r}
rm(list=ls())
library(data.table)
library(fixest)
library(DescTools)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(readxl)
library(stringr)
library(marginaleffects)

source('https://raw.githubusercontent.com/dratnadiwakara/r-utilities/refs/heads/main/summary_stat_tables.R')
```


```{r}
dt <- readRDS("C:/data/zip_competition_churn_panel_Nov24_v8.rds")
setDT(dt)


dt <- dt[branches_zip_lag1>=2 & !is.na(incumbent_dep_gr_3yr)]

dt[,incumbent_dep_gr_3yr:=Winsorize(incumbent_dep_gr_3yr, val = quantile(incumbent_dep_gr_3yr, probs = c(0.01, 0.99), na.rm = T)),by=YEAR]
# dt[,incumbent_dep_gr_3yr_clean:=Winsorize(incumbent_dep_gr_3yr_clean, val = quantile(incumbent_dep_gr_3yr_clean, probs = c(0.01, 0.99), na.rm = T)),by=YEAR]
dt[,incumbent_dep_gr_3yr_cd:=Winsorize(incumbent_dep_gr_3yr_cd, val = quantile(incumbent_dep_gr_3yr_cd, probs = c(0.01, 0.99), na.rm = T)),by=YEAR]
dt[,incumbent_dep_gr_3yr_clean_cd:=Winsorize(incumbent_dep_gr_3yr_clean_cd, val = quantile(incumbent_dep_gr_3yr_clean_cd, probs = c(0.01, 0.99), na.rm = T)),by=YEAR]

# 
# dt[,share_deps_closed:=Winsorize(share_deps_closed, val = quantile(share_deps_closed, probs = c(0, 0.99), na.rm = T)),by=YEAR]
# 
# dt[,share_deps_closed_no_app:=Winsorize(share_deps_closed_no_app, val = quantile(share_deps_closed_no_app, probs = c(0, 0.99), na.rm = T)),by=YEAR]
# dt[,share_deps_closed_app:=Winsorize(share_deps_closed_app, val = quantile(share_deps_closed_app, probs = c(0, 0.99), na.rm = T)),by=YEAR]
# dt[,share_deps_closed_high_up:=Winsorize(share_deps_closed_high_up, val = quantile(share_deps_closed_high_up, probs = c(0, 0.99), na.rm = T)),by=YEAR]
# dt[,share_deps_closed_low_up:=Winsorize(share_deps_closed_low_up, val = quantile(share_deps_closed_low_up, probs = c(0, 0.99), na.rm = T)),by=YEAR]
# 
# 
# dt[,incumbent_mkt_share_lag1:=Winsorize(incumbent_mkt_share_lag1, val = quantile(incumbent_mkt_share_lag1, probs = c(0, 0.99), na.rm = T)),by=YEAR]

dt[,share_cat:=as.factor(ifelse(share_deps_closed==0,1,ifelse(share_deps_closed<0.1,1,2)))]


zip_county <- fread("C:/data/zip_to_county_mapping.csv")
zip_county[,ZIP:=str_pad(ZIP,5,"left","0")]
zip_cbsa <- fread("C:/data/zip_to_cbsa_mapping.csv")
zip_cbsa[,ZIP:=str_pad(ZIP,5,"left","0")]

dt <- merge(dt,zip_county,by.x="ZIPBR",by.y="ZIP")
dt <- merge(dt,zip_cbsa,by.x="ZIPBR",by.y="ZIP")

dt[,county_yr:=paste(COUNTY,YEAR)]
dt[,cbsa_yr:=paste(CBSA,YEAR)]


dt[,gr_3y:= incumbent_dep_gr_3yr]
# dt[,gr_3y_cln:= incumbent_dep_gr_3yr_clean]
dt[,gr_3y_cd:= incumbent_dep_gr_3yr_cd]
dt[,gr_3y_cln_cd:= incumbent_dep_gr_3yr_clean_cd]

```


```{r}
# library(readxl)
# library(stringr)
# 
# acs_data <- readRDS("C:/data/acs_data_2010_2022_tract.rds")
# 
# tract_zip_crosswalk <- read_excel('C:/data/ZIP_TRACT_122019.xlsx')
# tract_zip_crosswalk <- data.table(tract_zip_crosswalk)
# tract_zip_crosswalk[,zip:=str_pad(ZIP,5,"left","0")]
# tract_zip_crosswalk[,tract:=as.character(TRACT)]
# tract_zip_crosswalk[,tract:=str_pad(tract,11,"left","0")]
# tract_zip_crosswalk[,tot_ratio:=TOT_RATIO]
# 
# 
# acs_with_zip <- acs_data %>%
#   left_join(tract_zip_crosswalk[,c("zip","tract","tot_ratio")], by = c("tract" = "tract"))
# 
# 
# 
# zip_aggregated_data <- acs_with_zip %>%
#   group_by(zip,yr) %>%
#   summarize(
#     # Weighted average of median income
#     median_income = sum(median_income * tot_ratio, na.rm = T) ,
#     
#     # Weighted average of percentage of population with a bachelor's degree
#     pct_college_educated = sum(pct_college_educated * tot_ratio, na.rm=T),
#     
#     # Weighted average of white population percentage
#     # white_population_pct = sum(white_populationE * RES_RATIO,na.rm=T),
#     
#     # Weighted average of median age
#     median_age = sum(median_age * tot_ratio,na.rm = T)
#     
#     # Total population is weighted by RES_RATIO
#     # total_population = sum(total_populationE * RES_RATIO)
#   )
# 
# zip_aggregated_data <- data.table(zip_aggregated_data)
# 
# irs_data <- readRDS("C:/data/irs_data_2010_2022_zip.rds")
# 
# 
# irs_data <- irs_data[,c("zipcode","yr","dividend_frac","capital_gain_frac")]
# irs_data[,zipcode:=str_pad(zipcode,5,"left","0")]
# # 
# zip_demo_data <- merge(zip_aggregated_data,irs_data,by.x=c("zip","yr"),by.y=c("zipcode","yr"),all.x=T)
# 
# 
# key_chars <- c("median_income","median_age","pct_college_educated","capital_gain_frac","dividend_frac")
# 
# zip_demo_data <- data.table(zip_demo_data)
# zip_demo_data[,paste0(key_chars,"_q"):=lapply(.SD, function(x) ntile(x,2)),by=yr,.SDcols = key_chars]
# 
# zip_demo_data[,sophisticated_ed_sm:=ifelse(!is.na(dividend_frac)  & pct_college_educated_q==2 & (dividend_frac_q==2 | capital_gain_frac_q==2),1,
#                                            ifelse(!is.na(dividend_frac),0,NA))]
# 
# 
# zip_demo_data <- zip_demo_data[,c("zip","yr","median_income","median_age","pct_college_educated","capital_gain_frac","dividend_frac","sophisticated_ed_sm")]
# 
# zip_demo_data[,age_bin:=ntile(median_age,2),by=yr]
# zip_demo_data[,above_median_age:=ifelse(age_bin==2,1,0)]
# zip_demo_data[,income_bin:=ntile(median_income,2),by=yr]
# zip_demo_data[,above_median_income:=ifelse(income_bin==2,1,0)]
# 
# temp1 <- zip_demo_data[yr==2010]
# for(y in c(2000:2009,2011:2012)) {
#   temp <- copy(temp1)
#   temp[,yr:=y]
#   zip_demo_data <- rbind(zip_demo_data,temp)
# }
# 
# temp1 <- zip_demo_data[yr==2013]
# for(y in 2014:2015) {
#   temp <- copy(temp1)
#   temp[,yr:=y]
#   zip_demo_data <- rbind(zip_demo_data,temp)
# }
# 
# 
# 
# temp1 <- zip_demo_data[yr==2016]
# for(y in 2017:2018) {
#   temp <- copy(temp1)
#   temp[,yr:=y]
#   zip_demo_data <- rbind(zip_demo_data,temp)
# }
# 
# 
# temp1 <- zip_demo_data[yr==2019]
# for(y in 2020:2021) {
#   temp <- copy(temp1)
#   temp[,yr:=y]
#   zip_demo_data <- rbind(zip_demo_data,temp)
# }
# 
# temp1 <- zip_demo_data[yr==2022]
# for(y in 2023:2025) {
#   temp <- copy(temp1)
#   temp[,yr:=y]
#   zip_demo_data <- rbind(zip_demo_data,temp)
# }
zip_demo_data <- readRDS("C:/data/zip_demo_data.rds")

dt <- merge(dt,
            zip_demo_data[!is.na(zip),.(zip,yr,sophisticated_ed_sm,age_bin,median_age,median_income,
                                        pct_college_educated,capital_gain_frac,dividend_frac,above_median_age,above_median_income)],
            by.x=c("ZIPBR","YEAR"),
            by.y=c("zip","yr"),
            all.x=T)

dt <- dt[!is.na(sophisticated_ed_sm)]
dt[, sophisticated := as.integer(sophisticated_ed_sm == 1L)]
dt[, factor_age_bin := factor(age_bin)]
dt[, log_income := log1p(median_income)]


```

```{r}
sod_data <- readRDS("C:/data/fdic_sod_2000_2025_simple.rds")

zip_panel <- sod_data[, .(
  total_deps = sum(DEPSUMBR, na.rm = TRUE),
  stcnty     = first(STCNTYBR) # Keep county code for controls later
), by = .(ZIPBR, YEAR)]

# 3. BALANCE THE PANEL (CRITICAL STEP)
# If a Zip had branches in 2000 and 2004 but none in 2001-2003, 
# simple shifting will fail. We must create a row for every year.
all_zips  <- unique(zip_panel$ZIPBR)
min_yr    <- min(zip_panel$YEAR)
max_yr    <- max(zip_panel$YEAR)
full_grid <- CJ(ZIPBR = all_zips, YEAR = min_yr:max_yr)

# Merge actual data onto the full grid
zip_panel_balanced <- merge(full_grid, zip_panel, by = c("ZIPBR", "YEAR"), all.x = TRUE)

# Fill NAs with 0 (No record = 0 deposits)
zip_panel_balanced[is.na(total_deps), total_deps := 0]

# 4. CALCULATE LAGS AND GROWTH
setorder(zip_panel_balanced, ZIPBR, YEAR)

zip_panel_balanced[, `:=`(
  # Lag t-1
  deps_lag1 = shift(total_deps, 1L, type = "lag"),
  
  # Lag t-4
  deps_lag4 = shift(total_deps, 4L, type = "lag")
), by = ZIPBR]

# Calculate the Growth Rate
zip_panel_balanced[, `:=`(
  zip_dep_growth_t4_t1 = fifelse(deps_lag4 > 0, 
                                 (deps_lag1 - deps_lag4) / deps_lag4, 
                                 NA_real_)
)]

# 5. CLEANUP
# Remove rows where calculation wasn't possible (e.g., the first 4 years of data)
final_growth_data <- zip_panel_balanced[!is.na(zip_dep_growth_t4_t1), 
                                        .(ZIPBR, YEAR, total_deps, 
                                          deps_lag1, deps_lag4, 
                                          zip_dep_growth_t4_t1)]

dt <- merge(dt,final_growth_data,by=c("ZIPBR","YEAR"),all.x=T)

dt[,zip_dep_growth_t4_t1:=Winsorize(zip_dep_growth_t4_t1, val = quantile(zip_dep_growth_t4_t1, probs = c(0.05, 0.95), na.rm = T)),by=YEAR]
dt[,relocation_openings_vol_share:=Winsorize(relocation_openings_vol_share, val = quantile(relocation_openings_vol_share, probs = c(0.05, 0.95), na.rm = T)),by=YEAR]


```



## Summary Stats - 2012
```{r}
temp <- summary_stats_function(dt[YEAR==2012],
                               c("gr_3y",
                                 "gr_3y_cd",
                                 "gr_3y_cln_cd",
                                 "share_deps_closed",
                                 "incumbent_mkt_share_lag1",
                                 "closer_remaining_mkt_share_lag1",
                                 "sophisticated",
                                 "branches_zip_lag1"))

md_table(temp)
```

## Summary Stats - 2019
```{r}
temp <- summary_stats_function(dt[YEAR==2019],
                               c("gr_3y",
                                 "gr_3y_cd",
                                 "gr_3y_cln_cd",
                                 "share_deps_closed",
                                 "incumbent_mkt_share_lag1",
                                 "closer_remaining_mkt_share_lag1",
                                 "sophisticated",
                                 "branches_zip_lag1"))

md_table(temp)
```
## Summary Stats - 2019; share_deps_closed>0
```{r}
temp <- summary_stats_function(dt[YEAR==2019 & share_deps_closed>0],
                               c("gr_3y",
                                 "gr_3y_cd",
                                 "gr_3y_cln_cd",
                                 "share_deps_closed",
                                 "incumbent_mkt_share_lag1",
                                 "closer_remaining_mkt_share_lag1",
                                 "sophisticated",
                                 "branches_zip_lag1"))

md_table(temp)
```


```{r}
setFixest_fml(
  ..fixef_y_z_cbsayr     = ~ ZIPBR + cbsa_yr,
  ..fixef_y_z_cntyyr     = ~ ZIPBR + county_yr,
  ..fixef_cbsayr     = ~ cbsa_yr,
  ..vcov      = ~ ZIPBR,
  ..controls = ~ +log1p(deps_lag1)+closer_remaining_mkt_share_lag1+ log1p(branches_zip_lag1),#+incumbent_mkt_share_lag1+zip_dep_growth_t4_t1+log1p(deps_lag1)+closer_remaining_mkt_share_lag1,
  ..fml_baseline_amt = ~share_deps_closed+..controls,
  ..fml_interaction_amt = ~share_deps_closed*sophisticated +..controls,
  ..fml_interactions_amt = ~share_deps_closed*sophisticated +share_deps_closed*above_median_income+ share_deps_closed*above_median_age +..controls
)

dict <- c(
  incumbent_dep_gr_3yr                        = "Dep gr(t to t+3)",
  incumbent_dep_gr_1yr                        = "Dep gr(t to t+1)",
  share_deps_closed      = "Share of deposits closed",
  frac_branches_closed      = "Share of branches closed",
  "log1p(branches_zip_lag1)" = "log(No of branches in ZIP t-1)",
  sophisticated_ed_sm = "Sophisticated",
  above_median_age = "Above median age",
  above_median_income = "Above median income",
  cbsa_yr = "CBSA*Year",
  county_yr           = "County*Year"
)


setFixest_etable(
  dict        = dict,
  se.below    = TRUE
)
```






# Baseline regression

```{r}
r <- list()
r[[1]] <- feols(gr_3y~share_deps_closed+..controls | ..fixef_y_z_cbsayr,data=dt[incumbent_mkt_share_lag1>0.25 ],vcov=~ZIPBR)
r[[2]] <- feols(gr_3y~share_deps_closed+..controls  | ..fixef_y_z_cntyyr,data=dt[incumbent_mkt_share_lag1>0.25],vcov=~ZIPBR)
r[[3]] <- feols(gr_3y_cd~share_deps_closed+..controls  | ..fixef_y_z_cbsayr,data=dt[incumbent_mkt_share_lag1>0.25 ],vcov=~ZIPBR)
r[[4]] <- feols(gr_3y_cd~share_deps_closed+..controls  | ..fixef_y_z_cntyyr,data=dt[incumbent_mkt_share_lag1>0.25],vcov=~ZIPBR)
r[[5]] <- feols(gr_3y_cln_cd~share_deps_closed+..controls  | ..fixef_y_z_cbsayr,data=dt[incumbent_mkt_share_lag1>0.25 ],vcov=~ZIPBR)
r[[6]] <- feols(gr_3y_cln_cd~share_deps_closed+..controls  | ..fixef_y_z_cntyyr,data=dt[incumbent_mkt_share_lag1>0.25],vcov=~ZIPBR)

md_table(etable(r,signif.code =  c("***"=0.01, "**"=0.05, "*"=0.10)))

```
# Demographic Interaction

```{r}
r <- list()
r[[1]] <- feols(gr_3y~share_deps_closed*sophisticated +..controls | ..fixef_y_z_cbsayr,data=dt[incumbent_mkt_share_lag1>0.25 ],vcov=~ZIPBR)
r[[2]] <- feols(gr_3y~share_deps_closed*sophisticated +..controls | ..fixef_y_z_cntyyr,data=dt[incumbent_mkt_share_lag1>0.25],vcov=~ZIPBR)
r[[3]] <- feols(gr_3y_cd~share_deps_closed*sophisticated +..controls | ..fixef_y_z_cbsayr,data=dt[incumbent_mkt_share_lag1>0.25 ],vcov=~ZIPBR)
r[[4]] <- feols(gr_3y_cd~share_deps_closed*sophisticated +..controls | ..fixef_y_z_cntyyr,data=dt[incumbent_mkt_share_lag1>0.25],vcov=~ZIPBR)
r[[5]] <- feols(gr_3y_cln_cd~share_deps_closed*sophisticated +..controls | ..fixef_y_z_cbsayr,data=dt[incumbent_mkt_share_lag1>0.25 ],vcov=~ZIPBR)
r[[6]] <- feols(gr_3y_cln_cd~share_deps_closed*sophisticated +..controls | ..fixef_y_z_cntyyr,data=dt[incumbent_mkt_share_lag1>0.25],vcov=~ZIPBR)
md_table(etable(r,signif.code =  c("***"=0.01, "**"=0.05, "*"=0.10)))

```



# Time Split


```{r}
r <- list()
r[[1]] <- feols(gr_3y~share_deps_closed*sophisticated +..controls  | ..fixef_y_z_cbsayr,data=dt[incumbent_mkt_share_lag1>0.25 & YEAR %in% 2000:2011],vcov=~ZIPBR)
r[[2]] <- feols(gr_3y_cd~share_deps_closed*sophisticated +..controls  | ..fixef_y_z_cbsayr,data=dt[incumbent_mkt_share_lag1>0.25 & YEAR %in% 2000:2011],vcov=~ZIPBR)
r[[3]] <- feols(gr_3y_cln_cd~share_deps_closed*sophisticated +..controls  | ..fixef_y_z_cbsayr,data=dt[incumbent_mkt_share_lag1>0.25 & YEAR %in% 2000:2011],vcov=~ZIPBR)
r[[4]] <- feols(gr_3y~share_deps_closed*sophisticated +..controls  | ..fixef_y_z_cbsayr,data=dt[incumbent_mkt_share_lag1>0.25 & YEAR %in% 2012:2024],vcov=~ZIPBR)
r[[5]] <- feols(gr_3y_cd~share_deps_closed*sophisticated +..controls  | ..fixef_y_z_cbsayr,data=dt[incumbent_mkt_share_lag1>0.25 & YEAR %in% 2012:2024],vcov=~ZIPBR)
r[[6]] <- feols(gr_3y_cln_cd~share_deps_closed*sophisticated +..controls  | ..fixef_y_z_cbsayr,data=dt[incumbent_mkt_share_lag1>0.25 & YEAR %in% 2012:2024],vcov=~ZIPBR)

# r[[3]] <- feols(gr_3y~..fml_interactions_amt | ..fixef_y_z_cbsayr,data=dt[YEAR %in% 2012:2019],vcov=~ZIPBR)
# r[[4]] <- feols(gr_3y~..fml_interactions_amt | ..fixef_y_z_cbsayr,data=dt[YEAR %in% 2020:2024],vcov=~ZIPBR)

md_table(etable(r,signif.code =  c("***"=0.01, "**"=0.05, "*"=0.10),
                 headers= c("2001:2011","2001:2011","2001:2011","2012:2022","2012:2022","2012:2022")))

```
